{% extends 'base.html' %}

{% block title %}
    Mi Progreso - Training+
{% endblock %}

{% block content %}
    <div class="progreso-title" data-aos="fade-right">
        <h1>Mi Progreso</h1>
        <p>Visualiza tu rendimiento y progreso</p>
    </div>

    <!-- Formulario para seleccionar entrenamiento -->
    <div class="select-training" data-aos="fade-right">
        <select id="entrenamiento-select" onchange="cambiarEntrenamiento(this)">
            <option value="" disabled {% if not id_entrenamiento_actual %}selected{% endif %}>
                Selecciona un entrenamiento
            </option>
            {% for entrenamiento in entrenamientos %}
                <option value="{{ entrenamiento.id_entrenamiento }}" 
                        {% if id_entrenamiento_actual and entrenamiento.id_entrenamiento == id_entrenamiento_actual %}selected{% endif %}>
                    {{ entrenamiento.nombre_entrenamiento }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Progreso en general -->
    <section class="progreso-general">
        <div class="card" data-aos="fade-in" data-aos-delay="100">
            <div class="card-title">
                <h2>Progreso General</h2>
                <i class='bx bx-trending-up'></i>
            </div>

            <div id="progreso-container">
                {% if entrenamientos %}

                <div class="card-data">
                    {% if entrenamiento_actual %}
                        <h3 id="porcentaje-texto">{{ "%.1f"|format(entrenamiento_actual.progreso) }}%</h3>

                        <div class="bar">
                            <div class="bar-progress" 
                                 id="barra-progreso" 
                                 data-progreso="{{ "%.1f"|format(entrenamiento_actual.progreso) }}">
                            </div>
                        </div>

                        <p id="texto-completado">Has completado un {{ "%.1f"|format(entrenamiento_actual.progreso) }}% de la rutina.</p>

                    {% else %}

                        {% set primer_entrenamiento = entrenamientos[0] %}

                        <h3 id="porcentaje-texto">{{ "%.1f"|format(primer_entrenamiento.progreso) }}%</h3>

                        <div class="bar">
                            <div class="bar-progress" 
                                 id="barra-progreso" 
                                 data-progreso="{{ "%.1f"|format(primer_entrenamiento.progreso) }}">
                            </div>
                        </div>

                        <p id="texto-completado">Has completado un {{ "%.1f"|format(primer_entrenamiento.progreso) }}% de la rutina.</p>

                    {% endif %}
                </div>

                {% else %}

                <div class="card-data">
                    <p>No tienes entrenamientos registrados</p>
                </div>

                {% endif %}
            </div>
        </div>

        <div class="card" data-aos="fade-in" data-aos-delay="200">
            <div class="card-title">
                <h2>Días Completados</h2>
                <i class='bx bx-calendar'></i>
            </div>

            <div class="card-data">
                {% if id_entrenamiento_actual %}
                    <h3>{{ dias_completados }}/{{ total_dias }}</h3>

                    <div class="bar day-progress">
                        <div class="bar-progress-day"
                            id="barra-dias"
                            data-progreso="{{ (dias_completados / total_dias * 100) if total_dias != 0 else 0 }}">
                        </div>
                    </div>
                    
                    <p>Has completado {{ dias_completados }} día{{ 's' if dias_completados != 1 else '' }} de {{ total_dias }} {{ 's' if dias_completados != 1 else '' }}</p>

                {% else %}

                    <h3>0/0</h3>

                    <div class="bar day-progress">
                        <div class="bar-progress-day" style="width: 0%"></div>
                    </div>

                    <p>0 días completado</p>
                {% endif %}
            </div>
        </div>

        <div class="card" data-aos="fade-in" data-aos-delay="300">
            <div class="card-title">
                <h2>Entrenador</h2>
                <i class='bx bxs-medal'></i>
            </div>

            <div class="card-data">
                <h3>
                    <a href="{{ url_for('usuario.usuario', id_usuario=entrenamiento_actual.id_usuario) }}">{{ entrenamiento_actual.entrenador }}</a>
                </h3>

                <p>Entrenador asignado a este plan.</p>
            </div>
        </div>
    </section>

    <!-- Grafico de rendimiento (lineal) -->
    <section class="rendimiento-container" data-aos="fade-down" data-aos-delay="300">
        <h2>Gráfico de Rendimiento</h2>

        <canvas id="lineChart" data-rendimiento='{{ datos_rendimiento_json }}'></canvas>

         <!-- Gráfico de Rendimiento (lineal) -->
         <script>
            document.addEventListener('DOMContentLoaded', function() {
                const canvas = document.getElementById('lineChart');
                const rendimientoData = JSON.parse(canvas.dataset.rendimiento || 'null');
                
                if (!rendimientoData) {
                    canvas.parentElement.innerHTML += '<p class="text-gray-500">No hay datos de rendimiento disponibles</p>';
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: rendimientoData.semanas,
                        datasets: [{
                            data: rendimientoData.porcentajes,
                            borderColor: '#DC2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.2)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 5,
                            pointHoverRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.raw + '% completado';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: 'Porcentaje completado' },
                                ticks: { callback: function(value) { return value + '%'; } }
                            },
                            x: {
                                title: { display: true, text: 'Semanas de entrenamiento' }
                            }
                        }
                    }
                });
            });
        </script>
    </section>

    <!-- Grafico de fuerza -->
    <section class="rendimiento-container" data-aos="fade-down">
        <h2>Evolución de Fuerza</h2>

        <canvas id="fuerzaMovChart" data-fuerza='{{ datos_fuerza_json }}'></canvas>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const canvasFuerza = document.getElementById('fuerzaMovChart');
                const fuerzaData = JSON.parse(canvasFuerza.dataset.fuerza || 'null');
                
                if (!fuerzaData) {
                    canvasFuerza.parentElement.innerHTML += '<p class="text-gray-500">No hay datos de fuerza disponibles</p>';
                    return;
                }
                
                const ctx2 = canvasFuerza.getContext('2d');
                new Chart(ctx2, {
                    type: 'polarArea',
                    data: {
                        labels: fuerzaData.tipos_fuerza,
                        datasets: [{
                            data: fuerzaData.valores,
                            backgroundColor: [
                                'rgba(220,38,38,0.7)',  // rojo - Empuje
                                'rgba(59,130,246,0.7)', // azul - Jale
                                'rgba(34,197,94,0.7)'   // verde - Resistencia
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#374151' }
                            },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                cornerRadius: 6,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label;
                                        const value = context.raw;
                                        const detalle = fuerzaData.detalle[label];
                                        
                                        if (label === 'Resistencia') {
                                            return [
                                                `Índice: ${value}`,
                                                `Reps promedio: ${detalle.avg_rep.toFixed(1)}`
                                            ];
                                        } else {
                                            return [
                                                `Índice: ${value}`,
                                                `Peso promedio: ${detalle.avg_peso.toFixed(1)} kg`
                                            ];
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            r: {
                                angleLines: { color: '#e5e7eb' },
                                grid: { color: '#d1d5db' },
                                pointLabels: {
                                    color: '#374151',
                                    font: { weight: 'bold' }
                                },
                                ticks: {
                                    color: '#6b7280',
                                    backdropColor: 'transparent'
                                },
                                suggestedMin: 0,
                                suggestedMax: 100
                            }
                        }
                    }
                });
            });
        </script>
    </section>

    <!-- Mejores Marcas-->
    <section class="marcadores-container-alumno" data-aos="fade-down">
        <h2>Mejores Marcas</h2>

        <div class="marcadores-alumno">
            {% for marca in mejores_marcas %}
                <div class="marcador">
                    <strong class="ejercicio-marcador">{{ marca.nombre }}</strong>
                    <span class="valor-marcador">
                        {% if marca.peso > 0 %}
                            {{ marca.peso }} Kg x {{ marca.repeticiones }} ({{ marca.series }} series)
                        {% else %}
                            {{ marca.display }}
                        {% endif %}
                    </span>
                </div>
            {% endfor %}
        </div>
    </section>

    <!-- Progreso Semanal -->
    <section class="progreso-semanal-container" data-aos="fade-down">
        <h2>Progreso Semanal</h2>
        
        <div class="semana">
            <div class="semana-title">
                <strong>Semana 1</strong>
                <p>01/01/2023</p>
            </div>

            <div class="datos">
                <div class="dias">
                    <p>
                        Días completados: <span>3/7</span>
                    </p>
                </div>

                <div class="ejercicios">
                    <p>
                        Ejercicios completados: <span>12/16</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="semana">
            <div class="semana-title">
                <strong>Semana 2</strong>
                <p>07/01/2023</p>
            </div>

            <div class="datos">
                <div class="dias">
                    <p>
                        Días completados: <span>4/6</span>
                    </p>
                </div>

                <div class="ejercicios">
                    <p>
                        Ejercicios completados: <span>10/12</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="semana">
            <div class="semana-title">
                <strong>Semana 3</strong>
                <p>14/01/2023</p>
            </div>

            <div class="datos">
                <div class="dias">
                    <p>
                        Días completados: <span>3/3</span>
                    </p>
                </div>

                <div class="ejercicios">
                    <p>
                        Ejercicios completados: <span>8/8</span>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <script>
        function cambiarEntrenamiento(select) {
            const idEntrenamiento = select.value;
            if (idEntrenamiento) {
                window.location.href = `/progreso/${idEntrenamiento}`;
            } else {
                window.location.href = '/progreso';
            }
        }
    </script>

    <script>
        // Barra de progreso rutina
        const barra = document.getElementById("barra-progreso");
        const progreso = barra.dataset.progreso;

        barra.style.width = progreso + "%";

        // Barra de progreso día
        const barraDias = document.getElementById("barra-dias");
        if (barraDias) {
            const progresoDias = barraDias.dataset.progreso;
            barraDias.style.width = progresoDias + "%";
        }
    </script>


{% endblock %}